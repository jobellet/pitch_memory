<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pitch Discrimination Experiment – Custom Logistic Fit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Full-page layout, no scrolling */
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      font-family: sans-serif;
      overflow: hidden;
    }
    .screen {
      position: relative;
      width: 100%; height: 100%;
      display: none;
    }
    .centered-content {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      text-align: center;
      width: 100%; height: 100%;
      padding: 20px; box-sizing: border-box;
    }
    button {
      font-size: 1rem;
      margin: 10px;
      padding: 10px 20px;
      cursor: pointer;
    }
    /* ===== Trial Screen Layout ===== */
    #trialScreen {
      position: relative;
      width: 100%; height: 100%;
      background-color: #fff;
    }
    /* A small bar at the top to display "Trial n/10" */
    #trialCounter {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 40px;
      line-height: 40px;
      background-color: #ddd;
      text-align: center;
      font-weight: bold;
      display: none;
    }
    /* Horizontal line at 50% screen height */
    #horizontalLine {
      position: absolute;
      left: 0; width: 100%; height: 2px;
      background-color: black; top: 50%;
      margin: 0; padding: 0;
    }
    /* Top half => Higher */
    #higherArea, #lowerArea {
      width: 100%; font-size: 2rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      background-color: gray; /* Initially disabled */
    }
    #higherArea {
      position: absolute; top: 40px; left: 0;
      height: calc(50% - 40px);
    }
    /* Bottom half => Lower */
    #lowerArea {
      position: absolute; bottom: 0; left: 0;
      height: 50%;
    }
  </style>
</head>
<body>

<!-- =============== 1. Intro Screen =============== -->
<div id="introScreen" class="screen">
  <div class="centered-content">
    <h1>Pitch Discrimination Experiment</h1>
    <p>
      You will hear two tones in quick succession.<br>
      Decide if the <strong>second tone</strong> is higher (↑) or lower (↓) than the first.<br><br>
      <strong>Test Mode</strong>: Large, fixed difference (12 semitones). You must get 5 consecutive correct to proceed.<br>
      <strong>Real Experiment</strong>:<br>
      - First 50 real trials are sampled uniformly in log space [0.01..1 semitone].<br>
      - Then we fit a logistic curve (0.5–1 range) to find intervals giving ~70–80% accuracy,<br>
        sampling that range in log space afterwards.<br>
      - Every 10 real trials beyond 50, you will see a <em>Batch End</em> screen to continue or stop.<br>
    </p>
    <button id="startTestBtn">Start Test Mode</button>
    <p>Or upload a previous experiment data file:</p>
    <button id="uploadBtn">Upload Data</button>
    <input type="file" id="fileInput" accept=".json" style="display:none;" />
  </div>
</div>

<!-- =============== 2. Trial Screen =============== -->
<div id="trialScreen" class="screen">
  <div id="trialCounter"></div>
  <div id="horizontalLine"></div>
  <div id="higherArea">HIGHER ↑</div>
  <div id="lowerArea">LOWER ↓</div>
</div>

<!-- =============== 3. Test Complete Screen =============== -->
<div id="testCompleteScreen" class="screen">
  <div class="centered-content">
    <h1>Test Complete!</h1>
    <p>
      You have reached 5 consecutive correct answers in the test trials.<br>
      Now the real experiment will begin.<br>
      The first 50 real trials are random semitones in [0.01..1] (log scale).<br>
      After 50, we will fit a logistic function around ~70–80% accuracy.<br><br>
      Press Enter or click below to continue.
    </p>
    <button id="startRealBtn">Continue</button>
  </div>
</div>

<!-- =============== 4. Batch End Screen =============== -->
<div id="batchEndScreen" class="screen">
  <div class="centered-content">
    <h1>Batch Complete</h1>
    <p>
      You have finished 10 trials in this batch.<br>
      Press <strong>Enter</strong> (or click below) to continue,<br>
      or press <strong>Esc</strong> (or click below) to stop.
    </p>
    <button id="continueBtn">Continue (Enter)</button>
    <button id="stopBtn">Stop (Esc)</button>
  </div>
</div>

<!-- =============== 5. Final Screen =============== -->
<div id="finalScreen" class="screen">
  <div class="centered-content">
    <h1>Experiment Ended</h1>
    <p>Thank you for participating!</p>
    <button id="downloadBtn">Download Data</button>
  </div>
</div>

<script>
/* ===========================
   0. Global Parameters
=========================== */
let audioContext;
const TONE_DURATION = 0.25;
const MIN_BASE_FREQ = 220;
const MAX_BASE_FREQ = 880;
const MIN_GAP_MS    = 250;
const MAX_GAP_MS    = 2000;

// Test mode
let isTestMode = false;
const NEEDED_TEST_CORRECT = 5;
let testCorrectCount = 0;

// Real mode
let realTrialCount = 0;
let trialNumberInBatch = 0;
let batchNumber = 0;

let lowSemitoneRange  = 0.01;
let highSemitoneRange = 1.0;

let alphaFit = -1;
let betaFit  = 0.5;

let trialData = [];

let firstSoundStartTime = 0;
let secondSoundStartTime = 0;
let canRespond = false;

let baseFrequency;
let secondFrequency;
let isSecondHigher;

/* ===========================
   1. Utility Functions
=========================== */
function logistic(x, alpha, beta) {
  return 0.5 + 0.5 / (1 + Math.exp(-(x - alpha) / beta));
}

function computeLogisticLoss(alpha, beta, xs, ys) {
  let loss = 0;
  for (let i = 0; i < xs.length; i++) {
    let pred = logistic(xs[i], alpha, beta);
    loss += (pred - ys[i]) ** 2;
  }
  return loss / xs.length;
}

function optimizeLogistic(xs, ys, initialAlpha = -1, initialBeta = 0.5, learningRate = 0.1, iterations = 1000) {
  let alpha = initialAlpha;
  let beta  = initialBeta;
  for (let iter = 0; iter < iterations; iter++) {
    let gradAlpha = 0;
    let gradBeta  = 0;
    for (let i = 0; i < xs.length; i++) {
      let pred = logistic(xs[i], alpha, beta);
      let error = pred - ys[i];
      let dPred_dZ = pred * (1 - pred);
      gradAlpha += error * dPred_dZ * (1 / beta);
      gradBeta  += error * dPred_dZ * ((xs[i] - alpha) / (beta**2));
    }
    gradAlpha /= xs.length;
    gradBeta  /= xs.length;
    alpha -= learningRate * gradAlpha;
    beta  -= learningRate * gradBeta;
    if(Math.abs(gradAlpha) < 1e-6 && Math.abs(gradBeta) < 1e-6) break;
  }
  return { alpha, beta };
}

function updateRangeFromLogistic(alpha, beta) {
  let validXs = [];
  for(let logx = -3; logx <= 0.3; logx += 0.01) {
    let p = logistic(logx, alpha, beta);
    if(p >= 0.7 && p <= 0.8) {
      validXs.push(logx);
    }
  }
  if(validXs.length > 0) {
    let minLog = Math.min(...validXs);
    let maxLog = Math.max(...validXs);
    lowSemitoneRange  = Math.max(0.01, Math.pow(10, minLog));
    highSemitoneRange = Math.max(lowSemitoneRange, Math.pow(10, maxLog));
  } else {
    lowSemitoneRange  = 0.01;
    highSemitoneRange = 1.0;
  }
}

/* ===========================
   2. Test Mode Functions
=========================== */
document.getElementById('startTestBtn').addEventListener('click', () => {
  trialData = [];
  isTestMode = true;
  testCorrectCount = 0;
  runTestTrial();
});

function runTestTrial() {
  switchScreen('trialScreen');
  hideTrialCounter(true);
  prepareResponseAreas();

  baseFrequency = randomBaseFreq();
  isSecondHigher = (Math.random() < 0.5);

  const diffSem = 12;
  let ratio = Math.pow(2, diffSem / 12);
  if(!isSecondHigher) ratio = 1 / ratio;
  secondFrequency = clampFreq(baseFrequency * ratio);

  setTimeout(() => {
    firstSoundStartTime = performance.now();
    playTone(baseFrequency, TONE_DURATION);

    const gap = MIN_GAP_MS + Math.random()*(MAX_GAP_MS - MIN_GAP_MS);
    setTimeout(() => {
      secondSoundStartTime = performance.now();
      playTone(secondFrequency, TONE_DURATION);
      enableResponseAreas();
    }, gap);
  }, 300);
}

function handleTestResponse(correct) {
  if(correct) {
    testCorrectCount++;
    alert(`Correct! (${testCorrectCount}/${NEEDED_TEST_CORRECT})`);
  } else {
    alert(`Wrong! Still ${testCorrectCount}/${NEEDED_TEST_CORRECT} correct.`);
  }
  if(testCorrectCount >= NEEDED_TEST_CORRECT) {
    switchScreen('testCompleteScreen');
  } else {
    runTestTrial();
  }
}

/* ===========================
   3. Start Real Experiment
=========================== */
document.getElementById('startRealBtn').addEventListener('click', () => {
  isTestMode = false;
  realTrialCount = 0;
  trialNumberInBatch = 0;
  batchNumber = 0;
  runRealTrial();
});

/* ===========================
   4. Real Experiment Functions
=========================== */
function runRealTrial() {
  switchScreen('trialScreen');
  hideTrialCounter(false);
  updateTrialCounter(trialNumberInBatch + 1, 10);
  prepareResponseAreas();

  baseFrequency = randomBaseFreq();
  isSecondHigher = (Math.random() < 0.5);

  let absSemitone;
  if(realTrialCount < 50) {
    absSemitone = pickRandomInLogSpace(0.01, 1.0);
  } else {
    absSemitone = pickRandomInLogSpace(lowSemitoneRange, highSemitoneRange);
  }

  let ratio = Math.pow(2, absSemitone / 12);
  if(!isSecondHigher) ratio = 1/ratio;
  secondFrequency = clampFreq(baseFrequency * ratio);

  setTimeout(() => {
    firstSoundStartTime = performance.now();
    playTone(baseFrequency, TONE_DURATION);

    const gap = MIN_GAP_MS + Math.random()*(MAX_GAP_MS - MIN_GAP_MS);
    setTimeout(() => {
      secondSoundStartTime = performance.now();
      playTone(secondFrequency, TONE_DURATION);
      enableResponseAreas();
    }, gap);
  }, 300);
}

function handleResponse(userSaysHigher) {
  if(!canRespond) return;

  const now = performance.now();
  const correct = (userSaysHigher === isSecondHigher);
  const gapMs = (secondSoundStartTime - firstSoundStartTime).toFixed(2);
  const rtMs  = (now - secondSoundStartTime).toFixed(2);

  const ratioVal = secondFrequency / baseFrequency;
  const usedSem = 12 * (Math.log(ratioVal)/Math.log(2));
  const absSem = Math.max(0.00001, Math.abs(usedSem));

  trialData.push({
    timestamp: new Date().toISOString(),
    isTestMode: isTestMode,
    batchNumber: isTestMode ? 0 : batchNumber,
    trialInBatch: isTestMode ? 0 : (trialNumberInBatch+1),
    firstPitchHz: baseFrequency,
    secondPitchHz: secondFrequency,
    gapDurationMs: gapMs,
    relativeDiffSemitones: absSem,
    userResponse: userSaysHigher ? "higher" : "lower",
    correctness: correct,
    reactionTimeMs: rtMs
  });

  if(isTestMode) {
    handleTestResponse(correct);
  } else {
    realTrialCount++;
    trialNumberInBatch++;
    if(trialNumberInBatch >= 10) {
      batchNumber++;
      if(realTrialCount >= 50) {
        fitCustomLogistic();
      }
      switchScreen('batchEndScreen');
    } else {
      runRealTrial();
    }
  }
}

/* ===========================
   5. Batch End Handlers
=========================== */
document.getElementById('continueBtn').addEventListener('click', () => {
  trialNumberInBatch = 0;
  runRealTrial();
});
document.getElementById('stopBtn').addEventListener('click', () => {
  switchScreen('finalScreen');
});

/* ===========================
   6. Logistic Fit
=========================== */
function fitCustomLogistic() {
  const realTrials = trialData.filter(t => !t.isTestMode);
  if(realTrials.length < 10) return;

  const xs = [];
  const ys = [];
  for(let t of realTrials) {
    const sem = t.relativeDiffSemitones;
    xs.push(Math.log10(sem));
    ys.push(t.correctness ? 1 : 0);
  }

  let { alpha, beta } = optimizeLogistic(xs, ys, alphaFit, betaFit, 0.1, 1000);
  alphaFit = alpha;
  betaFit  = beta;
  updateRangeFromLogistic(alphaFit, betaFit);
}

/* ===========================
   7. File Upload
=========================== */
document.getElementById('uploadBtn').addEventListener('click', () => {
  document.getElementById('fileInput').click();
});
document.getElementById('fileInput').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    try {
      const loadedData = JSON.parse(evt.target.result);
      if(Array.isArray(loadedData)) {
        trialData = loadedData.concat(trialData);
        const realCount = trialData.filter(t => !t.isTestMode).length;
        if(realCount >= 50) {
          isTestMode = false;
          fitCustomLogistic();
          realTrialCount = realCount;
          batchNumber = Math.floor(realTrialCount / 10);
          trialNumberInBatch = realTrialCount % 10;
          runRealTrial();
        } else {
          startTestTrials();
        }
      } else {
        alert("Invalid JSON format.");
      }
    } catch(err) {
      alert("Error parsing JSON: " + err);
    }
  };
  reader.readAsText(file);
});

/* ===========================
   8. Screen & UI Helpers
=========================== */
function switchScreen(screenId) {
  const screens = ["introScreen","trialScreen","testCompleteScreen","batchEndScreen","finalScreen"];
  screens.forEach(s => {
    document.getElementById(s).style.display = (s===screenId) ? 'block' : 'none';
  });
}
function hideTrialCounter(shouldHide) {
  document.getElementById('trialCounter').style.display = shouldHide ? "none" : "block";
}
function updateTrialCounter(current, total) {
  const tc = document.getElementById('trialCounter');
  tc.textContent = `Trial ${current} / ${total}`;
}
function prepareResponseAreas() {
  canRespond = false;
  document.getElementById('higherArea').style.backgroundColor = 'gray';
  document.getElementById('lowerArea').style.backgroundColor = 'gray';
}
function enableResponseAreas() {
  canRespond = true;
  document.getElementById('higherArea').style.backgroundColor = '#eef';
  document.getElementById('lowerArea').style.backgroundColor = '#fee';
}
function randomBaseFreq() {
  return Math.random()*(MAX_BASE_FREQ - MIN_BASE_FREQ) + MIN_BASE_FREQ;
}
function clampFreq(freq) {
  return Math.max(MIN_BASE_FREQ, Math.min(MAX_BASE_FREQ, freq));
}
function pickRandomInLogSpace(minVal, maxVal) {
  const logMin = Math.log10(minVal);
  const logMax = Math.log10(maxVal);
  if(logMax <= logMin) return (minVal + maxVal) / 2;
  const r = Math.random();
  const chosenLog = logMin + r*(logMax - logMin);
  return Math.pow(10, chosenLog);
}
function playTone(freq, durationSec) {
  if(!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  const osc = audioContext.createOscillator();
  osc.type = 'sine';
  osc.frequency.value = freq;
  const gain = audioContext.createGain();
  gain.gain.setValueAtTime(0, audioContext.currentTime);
  gain.gain.linearRampToValueAtTime(1, audioContext.currentTime + 0.01);
  gain.gain.setValueAtTime(1, audioContext.currentTime + durationSec - 0.01);
  gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + durationSec);
  osc.connect(gain).connect(audioContext.destination);
  osc.start();
  osc.stop(audioContext.currentTime + durationSec);
}

/* ===========================
   9. Download Data
=========================== */
document.getElementById('downloadBtn').addEventListener('click', () => {
  const dataStr = JSON.stringify(trialData, null, 2);
  const blob = new Blob([dataStr], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'experiment_data.json';
  a.click();
  URL.revokeObjectURL(url);
});

/* ===========================
   10. Keyboard Event Listener
=========================== */
document.addEventListener('keydown', function(e) {
  const trialVisible = document.getElementById('trialScreen').style.display === 'block';
  const batchEndVisible = document.getElementById('batchEndScreen').style.display === 'block';
  const testCompleteVisible = document.getElementById('testCompleteScreen').style.display === 'block';

  if(trialVisible) {
    if(e.key === 'ArrowUp') {
      e.preventDefault();
      handleResponse(true);
    } else if(e.key === 'ArrowDown') {
      e.preventDefault();
      handleResponse(false);
    }
  } else if(batchEndVisible) {
    if(e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('continueBtn').click();
    } else if(e.key === 'Escape') {
      e.preventDefault();
      document.getElementById('stopBtn').click();
    }
  } else if(testCompleteVisible) {
    if(e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('startRealBtn').click();
    }
  }
});

/* ===========================
   11. Start Experiment
=========================== */
switchScreen('introScreen');

/* Add click listeners for smartphone/touch input */
document.getElementById('higherArea').addEventListener('click', () => {
  handleResponse(true);
});
document.getElementById('lowerArea').addEventListener('click', () => {
  handleResponse(false);
});
</script>
</body>
</html>